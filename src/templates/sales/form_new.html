{% extends "base.html" %}

{% block title %}
{% if sale %}تعديل معاملة البيع{% else %}إضافة معاملة بيع جديدة{% endif %} - BroMan
{% endblock %}

{% block extra_css %}
<style>
    .form-section-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        padding: 25px;
        border: 1px solid #e0e0e0;
    }
    .section-title {
        font-size: 1.25rem;
        color: #343a40;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
    }
    .section-title i {
        margin-left: 10px;
        color: #007bff;
    }
    .input-group-text {
        background-color: #e9ecef;
        border-color: #ced4da;
    }
    .percentage-input {
        text-align: right;
    }
    .calculation-output-card {
        background: linear-gradient(145deg, #e2e6ea, #f8f9fa);
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 25px;
        border: 1px solid #d1d7dc;
        position: sticky;
        top: 20px;
    }
    .calculation-group-title {
        font-size: 1.1rem;
        color: #0056b3;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px dashed #cce5ff;
    }
    .calculation-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px dotted #dee2e6;
    }
    .calculation-row:last-child {
        border-bottom: none;
    }
    .calculation-label {
        font-weight: 500;
        color: #495057;
    }
    .calculation-value {
        font-weight: 600;
        color: #28a745;
        text-align: left;
        min-width: 120px; /* Ensure alignment */
    }
    .final-income-row {
        font-size: 1.2rem;
        font-weight: bold;
        color: #dc3545;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #007bff;
    }
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }
    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }
    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #5a6268;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="bi bi-house-door text-primary"></i>
                    {% if sale %}تعديل معاملة البيع{% else %}إضافة معاملة بيع جديدة{% endif %}
                </h1>
                <a href="/sales" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i>
                    العودة للقائمة
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Input Form -->
        <div class="col-lg-7">
            <form id="saleForm" novalidate>
                {% if sale %}
                <input type="hidden" id="saleId" value="{{ sale.id }}">
                {% endif %}
                
                <!-- Client Information -->
                <div class="form-section-card">
                    <h5 class="section-title"><i class="bi bi-person-circle"></i> معلومات العميل والوحدة</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="client_name" class="form-label">اسم العميل <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="client_name" name="client_name" 
                                   value="{% if sale %}{{ sale.client_name }}{% endif %}" required>
                            <div class="invalid-feedback">يرجى إدخال اسم العميل</div>
                        </div>
                        <div class="col-md-6">
                            <label for="unit_code" class="form-label">كود الوحدة <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="unit_code" name="unit_code" 
                                   value="{% if sale %}{{ sale.unit_code }}{% endif %}" required>
                            <div class="invalid-feedback">يرجى إدخال كود الوحدة</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="property_type" class="form-label">نوع العقار المباع <span class="text-danger">*</span></label>
                            <select class="form-select" id="property_type" name="property_type" required>
                                <option value="">اختر نوع العقار</option>
                                <option value="شقة" {% if sale and sale.property_type == 'شقة' %}selected{% endif %}>شقة</option>
                                <option value="تجاري" {% if sale and sale.property_type == 'تجاري' %}selected{% endif %}>تجاري</option>
                                <option value="اداري" {% if sale and sale.property_type == 'اداري' %}selected{% endif %}>اداري</option>
                                <option value="طبي" {% if sale and sale.property_type == 'طبي' %}selected{% endif %}>طبي</option>
                            </select>
                            <div class="invalid-feedback">يرجى اختيار نوع العقار</div>
                        </div>
                        <div class="col-md-6">
                            <label for="sale_date" class="form-label">تاريخ البيع <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="sale_date" name="sale_date" 
                                   value="{% if sale %}{{ sale.sale_date.isoformat() }}{% else %}{{ "now"|date("%Y-%m-%d") }}{% endif %}" required>
                            <div class="invalid-feedback">يرجى إدخال تاريخ البيع</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="unit_price" class="form-label">سعر الوحدة <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control text-left" id="unit_price" name="unit_price" 
                                       value="{% if sale %}{{ sale.unit_price|float }}{% endif %}" 
                                       step="0.01" min="0" required>
                                <span class="input-group-text">جنيه</span>
                            </div>
                            <div class="invalid-feedback">يرجى إدخال سعر الوحدة</div>
                        </div>
                    </div>
                </div>

                <!-- Salesperson Information -->
                <div class="form-section-card">
                    <h5 class="section-title"><i class="bi bi-people"></i> معلومات السيلز ومدير المبيعات</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="salesperson_name" class="form-label">ســلز</label>
                            <input type="text" class="form-control" id="salesperson_name" name="salesperson_name" 
                                   value="{% if sale %}{{ sale.salesperson_name }}{% endif %}">
                        </div>
                        <div class="col-md-6">
                            <label for="sales_manager_name" class="form-label">مدير المبيعات</label>
                            <input type="text" class="form-control" id="sales_manager_name" name="sales_manager_name" 
                                   value="{% if sale %}{{ sale.sales_manager_name }}{% endif %}">
                        </div>
                    </div>
                </div>

                <!-- Commission Rates -->
                <div class="form-section-card">
                    <h5 class="section-title"><i class="bi bi-percent"></i> نسب العمولات</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="company_commission_rate" class="form-label">نسبة عمولة الشركة <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control percentage-input" id="company_commission_rate" 
                                       name="company_commission_rate" step="0.01" min="0" max="100" 
                                       value="{% if sale %}{{ sale.company_commission_rate|float * 100 }}{% else %}0{% endif %}" required>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="salesperson_commission_rate" class="form-label">نسبة عمولة السلز</label>
                            <div class="input-group">
                                <input type="number" class="form-control percentage-input" id="salesperson_commission_rate" 
                                       name="salesperson_commission_rate" step="0.01" min="0" max="100" 
                                       value="{% if sale %}{{ sale.salesperson_commission_rate|float * 100 }}{% else %}0{% endif %}">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="salesperson_incentive_rate" class="form-label">نسبة الحافز للسلز</label>
                            <div class="input-group">
                                <input type="number" class="form-control percentage-input" id="salesperson_incentive_rate" 
                                       name="salesperson_incentive_rate" step="0.01" min="0" max="100" 
                                       value="{% if sale %}{{ sale.salesperson_incentive_rate|float * 100 }}{% else %}0{% endif %}">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="sales_manager_commission_rate_input" class="form-label">نسبة عمولة مدير المبيعات</label>
                            <div class="input-group">
                                <input type="number" class="form-control percentage-input" id="sales_manager_commission_rate_input" 
                                       name="sales_manager_commission_rate_input" step="0.01" min="0" max="100" 
                                       value="{% if sale %}{{ sale.sales_manager_commission_rate|float * 100 }}{% else %}0{% endif %}">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tax Rates -->
                <div class="form-section-card">
                    <h5 class="section-title"><i class="bi bi-calculator"></i> نسب الضرائب</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="vat_rate" class="form-label">نسبة ضريبة القيمة المضافة</label>
                            <div class="input-group">
                                <input type="number" class="form-control percentage-input" id="vat_rate" 
                                       name="vat_rate" step="0.01" min="0" max="100" 
                                       value="{% if sale %}{{ sale.vat_rate|float * 100 }}{% else %}14{% endif %}">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="sales_tax_rate" class="form-label">نسبة ضريبة المبيعات</label>
                            <div class="input-group">
                                <input type="number" class="form-control percentage-input" id="sales_tax_rate" 
                                       name="sales_tax_rate" step="0.01" min="0" max="100" 
                                       value="{% if sale %}{{ sale.sales_tax_rate|float * 100 }}{% else %}5{% endif %}">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="annual_tax_rate" class="form-label">نسبة الضريبة السنوية</label>
                            <div class="input-group">
                                <input type="number" class="form-control percentage-input" id="annual_tax_rate" 
                                       name="annual_tax_rate" step="0.01" min="0" max="100" 
                                       value="{% if sale %}{{ sale.annual_tax_rate|float * 100 }}{% else %}22.5{% endif %}">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="salesperson_tax_rate" class="form-label">نسبة ضريبة السلز</label>
                            <div class="input-group">
                                <input type="number" class="form-control percentage-input" id="salesperson_tax_rate" 
                                       name="salesperson_tax_rate" step="0.01" min="0" max="100" 
                                       value="{% if sale %}{{ sale.salesperson_tax_rate|float * 100 }}{% else %}0{% endif %}">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="sales_manager_tax_rate" class="form-label">نسبة ضريبة مدير المبيعات</label>
                            <div class="input-group">
                                <input type="number" class="form-control percentage-input" id="sales_manager_tax_rate" 
                                       name="sales_manager_tax_rate" step="0.01" min="0" max="100" 
                                       value="{% if sale %}{{ sale.sales_manager_tax_rate|float * 100 }}{% else %}0{% endif %}">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-section-card">
                    <div class="d-flex justify-content-between">
                        <a href="/sales" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i>
                            إلغاء
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle"></i>
                            {% if sale %}تحديث المعاملة{% else %}حفظ المعاملة{% endif %}
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Right Column: Calculations Display -->
        <div class="col-lg-5">
            <div class="calculation-output-card">
                <h5 class="section-title"><i class="bi bi-calculator-fill"></i> نتائج الحسابات</h5>
                
                <div class="mb-4">
                    <h6 class="calculation-group-title">العمولة المستحقة للشركة من شركة المبيعات</h6>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي عمولة الشركة بدون ضرائب</span>
                        <span class="calculation-value" id="output_total_company_commission_before_tax">0.00 جنيه</span>
                    </div>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي الحافز المسلم للسلز</span>
                        <span class="calculation-value" id="output_total_salesperson_incentive_paid">0.00 جنيه</span>
                    </div>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي المبلغ المسلم للشركة بعد 5%</span>
                        <span class="calculation-value" id="output_total_company_income_after_5_percent">0.00 جنيه</span>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="calculation-group-title">ضرائب المبيعات والقيمة المضافة</h6>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي مبلغ العمولة بعد 14%</span>
                        <span class="calculation-value" id="output_company_commission_amount">0.00 جنيه</span>
                    </div>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي القيمة المضافة 14%</span>
                        <span class="calculation-value" id="output_vat_amount">0.00 جنيه</span>
                    </div>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي ضريبة المبيعات 5%</span>
                        <span class="calculation-value" id="output_sales_tax_amount">0.00 جنيه</span>
                    </div>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي ضريبة 19%</span>
                        <span class="calculation-value" id="output_total_vat_and_sales_tax_amount">0.00 جنيه</span>
                    </div>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي صافي مبلغ الشركة (بعد ضريبة المبيعات فقط)</span>
                        <span class="calculation-value" id="output_net_company_income_after_sales_tax">0.00 جنيه</span>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="calculation-group-title">عمولة السيلز</h6>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي المبلغ المستحق للسلز (قبل الضريبة)</span>
                        <span class="calculation-value" id="output_total_salesperson_income_before_tax">0.00 جنيه</span>
                    </div>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي الضريبة على السلز</span>
                        <span class="calculation-value" id="output_salesperson_tax_amount">0.00 جنيه</span>
                    </div>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي المبلغ المسلم للسيلز (بعد الضريبة)</span>
                        <span class="calculation-value" id="output_net_salesperson_income">0.00 جنيه</span>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="calculation-group-title">عمولة مدير المبيعات</h6>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي المبلغ المستحق لمدير المبيعات</span>
                        <span class="calculation-value" id="output_total_sales_manager_income_before_tax">0.00 جنيه</span>
                    </div>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي الضريبة على مدير المبيعات</span>
                        <span class="calculation-value" id="output_sales_manager_tax_amount">0.00 جنيه</span>
                    </div>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي المبلغ المسلم لمدير المبيعات</span>
                        <span class="calculation-value" id="output_net_sales_manager_income">0.00 جنيه</span>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="calculation-group-title">الضريبة السنوية</h6>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي صافي مبلغ الشركة (بعد الضرائب وعمولة الوسيط)</span>
                        <span class="calculation-value" id="output_net_company_income_after_all_taxes_and_commissions">0.00 جنيه</span>
                    </div>
                    <div class="calculation-row">
                        <span class="calculation-label">اجمالي الضريبة السنوية 22,5%</span>
                        <span class="calculation-value" id="output_annual_tax_amount">0.00 جنيه</span>
                    </div>
                </div>

                <div class="final-income-row calculation-row">
                    <span class="calculation-label">صافي دخل الشركة بعد كل الضرائب وعمولة السيلز</span>
                    <span class="calculation-value" id="output_final_company_income">0.00 جنيه</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const saleForm = document.getElementById("saleForm");
        const saleId = document.getElementById("saleId") ? document.getElementById("saleId").value : null;

        const inputFields = saleForm.querySelectorAll("input[type=\"number\"], input[type=\"text\"], input[type=\"date\"], select");

        const currencyFormatter = new Intl.NumberFormat("ar-EG", {
            style: "currency",
            currency: "EGP",
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        function formatCurrency(value) {
            return currencyFormatter.format(value);
        }

        function getFormData() {
            const formData = {};
            inputFields.forEach(field => {
                let value = field.value;
                if (field.type === "number") {
                    value = parseFloat(value);
                    if (field.classList.contains("percentage-input")) {
                        value = value / 100; // Convert percentage to decimal
                    }
                }
                formData[field.name] = value;
            });
            // Special handling for sales_manager_commission_rate_input to sales_manager_commission_rate
            if (formData.sales_manager_commission_rate_input !== undefined) {
                formData.sales_manager_commission_rate = formData.sales_manager_commission_rate_input;
                delete formData.sales_manager_commission_rate_input;
            }
            return formData;
        }

        async function calculatePreview() {
            const formData = getFormData();
            console.log("Form Data for Preview:", formData);

            try {
                console.log("Sending request to /api/sales/preview with method POST and body:", JSON.stringify(formData));
                const response = await fetch("/api/sales/preview", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "خطأ في حساب المعاينة");
                }

                const result = await response.json();
                console.log("Calculation Result:", result);
                updateOutputDisplay(result);
            } catch (error) {
                console.error("Error during preview calculation:", error);
                // Optionally display an error message to the user
            }
        }

        function updateOutputDisplay(results) {
            document.getElementById("output_total_company_commission_before_tax").textContent = formatCurrency(results.total_company_commission_before_tax || 0);
            document.getElementById("output_total_salesperson_incentive_paid").textContent = formatCurrency(results.total_salesperson_incentive_paid || 0);
            document.getElementById("output_total_company_income_after_5_percent").textContent = formatCurrency(results.total_company_income_after_5_percent || 0);

            document.getElementById("output_company_commission_amount").textContent = formatCurrency(results.company_commission_amount || 0);
            document.getElementById("output_vat_amount").textContent = formatCurrency(results.vat_amount || 0);
            document.getElementById("output_sales_tax_amount").textContent = formatCurrency(results.sales_tax_amount || 0);
            document.getElementById("output_total_vat_and_sales_tax_amount").textContent = formatCurrency(results.total_vat_and_sales_tax_amount || 0);
            document.getElementById("output_net_company_income_after_sales_tax").textContent = formatCurrency(results.net_company_income_after_sales_tax || 0);

            document.getElementById("output_total_salesperson_income_before_tax").textContent = formatCurrency(results.total_salesperson_income_before_tax || 0);
            document.getElementById("output_salesperson_tax_amount").textContent = formatCurrency(results.salesperson_tax_amount || 0);
            document.getElementById("output_net_salesperson_income").textContent = formatCurrency(results.net_salesperson_income || 0);

            document.getElementById("output_total_sales_manager_income_before_tax").textContent = formatCurrency(results.total_sales_manager_income_before_tax || 0);
            document.getElementById("output_sales_manager_tax_amount").textContent = formatCurrency(results.sales_manager_tax_amount || 0);
            document.getElementById("output_net_sales_manager_income").textContent = formatCurrency(results.net_sales_manager_income || 0);

            document.getElementById("output_annual_tax_amount").textContent = formatCurrency(results.annual_tax_amount || 0);
            document.getElementById("output_net_company_income_after_all_taxes_and_commissions").textContent = formatCurrency(results.net_company_income_after_all_taxes_and_commissions || 0);

            document.getElementById("output_final_company_income").textContent = formatCurrency(results.final_company_income || 0);
        }

        // Attach event listeners for real-time calculation
        inputFields.forEach(field => {
            field.addEventListener("input", calculatePreview);
            if (field.type === "select-one") { // For select elements
                field.addEventListener("change", calculatePreview);
            }
        });

        // Initial calculation on page load if editing an existing sale
        if (saleId) {
            // Populate form fields with existing sale data (already done by Jinja)
            // Then trigger a preview calculation
            calculatePreview();
        }

        saleForm.addEventListener("submit", async function(event) {
            event.preventDefault();
            saleForm.classList.add("was-validated");

            if (!saleForm.checkValidity()) {
                return;
            }

            const formData = getFormData();
            const url = saleId ? `/api/sales/${saleId}` : "/api/sales";
            const method = saleId ? "PUT" : "POST";

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    window.location.href = "/sales"; // Redirect to sales list
                } else {
                    alert(result.error || "حدث خطأ أثناء حفظ المعاملة");
                }
            } catch (error) {
                console.error("Error saving sale:", error);
                alert("حدث خطأ غير متوقع أثناء حفظ المعاملة");
            }
        });

        // Initial calculation for new sale form to show default values
        if (!saleId) {
            calculatePreview();
        }
    });
</script>
{% endblock %}

